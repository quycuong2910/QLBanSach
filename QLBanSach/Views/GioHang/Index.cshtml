@model IEnumerable<QLBanSach.Models.ChiTietGioHang>
@{
    ViewData["Title"] = "Giỏ hàng";
    var gioHang = ViewBag.GioHang as QLBanSach.Models.GioHang;
}

<link href="~/css/GioHang.css" rel="stylesheet" />

<style>
    .table thead {
        background-color: #0d6efd;
        color: white;
    }

    .table th,
    .table td {
        border: 1px solid #0d6efd !important; /* Viền xanh biển */
    }

    .table {
        border: 1px solid #0d6efd !important; /* Viền ngoài của bảng */
        border-collapse: collapse !important; /* Gộp viền cho đẹp */
    }

        .table thead th {
            background-color: #0d6efd !important; /* Xanh biển */
            color: white !important; /* Chữ trắng */
            text-align: center;
            vertical-align: middle;
        }
    .table img {
        width: 60px; /* Thu nhỏ chiều ngang */
        height: 80px; /* Chiều cao vừa phải */
        object-fit: cover; /* Cắt ảnh cho đẹp */
        border-radius: 6px; /* Bo góc mềm mại */
        box-shadow: 0 0 4px rgba(0,0,0,0.15);
    }
    .btn-outline-secondary.btn-sm {
        color: #0d6efd;
        border-color: #0d6efd;
        transition: all 0.3s ease;
    }

        .btn-outline-secondary.btn-sm:hover {
            background-color: #0d6efd;
            color: white;
        }

    .btn-danger:hover {
        background-color: #b02a37;
        border-color: #b02a37;
    }

    .so-luong-box {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }

    .so-luong-text {
        min-width: 38px;
        padding: 6px 6px;
        font-weight: bold;
        font-size: 16px;
        color: #0d6efd;
        border: 1px solid #0d6efd;
        border-radius: 8px;
        text-align: center;
        background: #eaf3ff;
    }

    .btn-minus, .btn-plus {
        width: 36px;
        height: 36px;
        padding: 0;
        font-size: 20px;
        border-radius: 8px;
        border: 1px solid #0d6efd;
        background: white;
        color: #0d6efd;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: 0.2s;
    }


    .so-luong-text {
        min-width: 42px;
        height: 36px;
        padding: 0;
        font-weight: bold;
        font-size: 17px;
        color: #0d6efd;
        border: 1px solid #0d6efd;
        border-radius: 8px;
        text-align: center;
        background: #eaf3ff;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>


<h2 class="mb-3">Giỏ hàng của bạn</h2>

@if (gioHang != null)
{
    <div class="mb-3">
        <p><strong>Mã giỏ hàng:</strong> @gioHang.MaGioHang</p>
        <p><strong>Ngày tạo:</strong> @gioHang.NgayTao.ToString("dd/MM/yyyy")</p>
    </div>
}

<hr />

@if (Model == null || !Model.Any())
{
    <div class="alert alert-info text-center">
        Giỏ hàng hiện đang trống.
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle">
            <thead class="table-light">
                <tr>
                    <th>#</th>
                    <th>Ảnh</th>
                    <th>Tên sách</th>
                    <th>Giá</th>
                    <th style="width:150px;">Số lượng</th>
                    <th>Tổng tiền</th>
                    <th>Hành động</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.Select((value, index) => new { value, index }))
                {
                    <tr data-id="@item.value.MaChiTiet">
                        <td>@(item.index + 1)</td>
                        <td>
                            @if(!string.IsNullOrEmpty(item.value.Sach?.Anh))
                            {
                                <img src="~/Images/@item.value.Sach.Anh" alt="@item.value.Sach.TenSach" class="img-thumbnail" />
                            }
                        </td>
                        <td>@item.value.Sach?.TenSach</td>
                        <td class="gia" data-gia="@item.value.Sach.Gia">
                            @(item.value.Sach != null ? item.value.Sach.Gia.ToString("N0") + " VNĐ" : "-")
                        </td>
                        <td>
                            <div class="so-luong-box">
                                <button type="button" class="btn-minus" data-max="@item.value.Sach.SoLuong">-</button>
                                <span class="so-luong-text" data-value="@item.value.SoLuong">@item.value.SoLuong</span>
                                <button type="button" class="btn-plus" data-max="@item.value.Sach.SoLuong">+</button>
                            </div>
                        </td>
                        <td class="tong-tien">
                            @(item.value.Sach != null ? (item.value.SoLuong * item.value.Sach.Gia).ToString("N0") + " VNĐ" : "-")
                        </td>
                        <td>
                            <button type="button" class="btn btn-sm btn-danger btn-remove" data-id="@item.value.MaChiTiet" title="Xóa sản phẩm">
                                <i class="fas fa-trash"></i> Xóa
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="d-flex justify-content-between mt-3">
        <a class="btn btn-secondary" asp-action="Index" asp-controller="Home">Tiếp tục mua sắm</a>
        <a class="btn btn-primary" asp-action="DatHang" asp-controller="DonHang" asp-route-maGioHang="@gioHang.MaGioHang">
            Đặt Đơn Hàng
        </a>
    </div>

    <div class="mt-3 text-end">
        <strong>Tổng cộng: </strong> <span id="tong-cong"></span>
    </div>
}

@section Scripts {
    <script>
        function formatVND(number) {
            return number.toLocaleString('vi-VN') + ' VNĐ';
        }

        function updateTongTienRow(row) {
            const gia = parseInt(row.querySelector('.gia').dataset.gia);
            const sl = parseInt(row.querySelector('.so-luong-text').dataset.value);
            row.querySelector('.tong-tien').innerText = formatVND(gia * sl);
            updateTongCong();
        }

        function updateTongCong() {
            let tong = 0;
            document.querySelectorAll('tbody tr').forEach(row => {
                const gia = parseInt(row.querySelector('.gia').dataset.gia);
                const sl = parseInt(row.querySelector('.so-luong-text').dataset.value);
                tong += gia * sl;
            });
            document.getElementById('tong-cong').innerText = formatVND(tong);
        }

        function capNhatSoLuongServer(maChiTiet, soLuong) {
            fetch('@Url.Action("UpdateSoLuong", "GioHang")', {
                method: 'POST',
                headers: {'Content-Type':'application/x-www-form-urlencoded'},
                body: `maChiTiet=${maChiTiet}&soLuong=${soLuong}&__RequestVerificationToken=${$('input[name="__RequestVerificationToken"]').val()}`
            });
        }

        document.querySelectorAll('.btn-plus').forEach(btn => {
            btn.addEventListener('click', e => {
                const row = btn.closest('tr');
                const slText = row.querySelector('.so-luong-text');
                const max = parseInt(btn.dataset.max);
                let sl = parseInt(slText.dataset.value);

                if (sl < max) sl++;
                slText.dataset.value = sl;
                slText.innerText = sl;

                updateTongTienRow(row);
                capNhatSoLuongServer(row.dataset.id, sl);
            });
        });

        document.querySelectorAll('.btn-minus').forEach(btn => {
            btn.addEventListener('click', e => {
                const row = btn.closest('tr');
                const slText = row.querySelector('.so-luong-text');
                let sl = parseInt(slText.dataset.value);

                if (sl > 1) sl--;
                slText.dataset.value = sl;
                slText.innerText = sl;

                updateTongTienRow(row);
                capNhatSoLuongServer(row.dataset.id, sl);
            });
        });

        document.querySelectorAll('.btn-remove').forEach(btn => {
            btn.addEventListener('click', function () {

                const id = this.dataset.id;
                if (!confirm("Bạn có chắc muốn xóa sản phẩm này?")) return;

                fetch('@Url.Action("RemoveChiTiet", "GioHang")', {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body: `maChiTiet=${id}&__RequestVerificationToken=${$('input[name="__RequestVerificationToken"]').val()}`
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        // Xóa hàng khỏi bảng
                        document.querySelector(`tr[data-id="${id}"]`).remove();
                        updateTongCong();
                        if (document.querySelectorAll("tbody tr").length === 0) {
                            document.querySelector(".table-responsive").innerHTML = `
                                    <div class="alert alert-info text-center">
            Giỏ hàng hiện đang trống.
        </div>`;
                        }
                    } else {
                        alert("Xóa thất bại!");
                    }
                });

            });
        });
        updateTongCong();
    </script>

}
